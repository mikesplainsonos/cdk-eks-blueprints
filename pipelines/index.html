
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>Pipelines - Amazon EKS SSP Quick Start</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipelines" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Amazon EKS SSP Quick Start" class="md-header__button md-logo" aria-label="Amazon EKS SSP Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS SSP Quick Start
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pipelines
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-quickstart/ssp-amazon-eks/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/ssp-amazon-eks
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Amazon EKS SSP Quick Start" class="md-nav__button md-logo" aria-label="Amazon EKS SSP Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Amazon EKS SSP Quick Start
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-quickstart/ssp-amazon-eks/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/ssp-amazon-eks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../core-concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../teams/" class="md-nav__link">
        Teams
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pipelines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Pipelines
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#defining-your-blueprint-to-use-with-pipeline" class="md-nav__link">
    Defining your blueprint to use with pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-pipeline" class="md-nav__link">
    Creating a pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-stages" class="md-nav__link">
    Creating stages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-waves" class="md-nav__link">
    Adding Waves
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-the-pipeline-stack" class="md-nav__link">
    Build the pipeline stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-pipelines" class="md-nav__link">
    Deploying Pipelines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          AddOns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AddOns" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          AddOns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/app-mesh/" class="md-nav__link">
        AWS App Mesh
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/argo-cd/" class="md-nav__link">
        ArgoCD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/aws-load-balancer-controller/" class="md-nav__link">
        AWS Load Balancer Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/coredns/" class="md-nav__link">
        CoreDns
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/cluster-autoscaler/" class="md-nav__link">
        Cluster Autoscaler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/container-insights/" class="md-nav__link">
        Container Insights
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/external-dns/" class="md-nav__link">
        External DNS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/kube-proxy/" class="md-nav__link">
        Kube Proxy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/metrics-server/" class="md-nav__link">
        Metrics Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/nginx/" class="md-nav__link">
        Nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/ssm-agent/" class="md-nav__link">
        SSM Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/secrets-store/" class="md-nav__link">
        Secrets Store
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/vpc-cni/" class="md-nav__link">
        Vpc Cni
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/weaveworks/weave-gitops-ssp-addon" class="md-nav__link">
        Weave GitOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../addons/xray/" class="md-nav__link">
        AWS XRay
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Cluster Providers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cluster Providers" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Cluster Providers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/asg-cluster-provider/" class="md-nav__link">
        ASG Cluster Provider
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/mng-cluster-provider/" class="md-nav__link">
        MNG Cluster Provider
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/fargate-cluster-provider/" class="md-nav__link">
        Fargate Cluster Provider
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../extensibility/" class="md-nav__link">
        Extensibility
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#defining-your-blueprint-to-use-with-pipeline" class="md-nav__link">
    Defining your blueprint to use with pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-pipeline" class="md-nav__link">
    Creating a pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-stages" class="md-nav__link">
    Creating stages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-waves" class="md-nav__link">
    Adding Waves
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-the-pipeline-stack" class="md-nav__link">
    Build the pipeline stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-pipelines" class="md-nav__link">
    Deploying Pipelines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/aws-quickstart/ssp-amazon-eks/edit/master/docs/pipelines.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="pipelines">Pipelines<a class="headerlink" href="#pipelines" title="Permanent link">&para;</a></h1>
<p>While it is convenient to leverage the CDK command line tool to deploy your first cluster, we recommend setting up automated pipelines that will be responsible for deploying and updating your EKS infrastructure. </p>
<p>To accomplish this, the EKS SSP - Reference Solution leverages the <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/pipelines-readme.html"><code>Pipelines</code></a> CDK module. This module makes it trivial to create Continuous Delivery (CD) pipelines via CodePipeline that are responsible for deploying and updating your infrastructure. </p>
<p>Additionally, the EKS SSP - Reference Solution leverages the GitHub integration that the <code>Pipelines</code> CDK module provides in order to integrate our pipelines with GitHub. The end result is that any new configuration pushed to a GitHub repository containing our CDK will be automatically deployed.</p>
<h2 id="defining-your-blueprint-to-use-with-pipeline">Defining your blueprint to use with pipeline<a class="headerlink" href="#defining-your-blueprint-to-use-with-pipeline" title="Permanent link">&para;</a></h2>
<p>Creation of a pipeline starts with defining the blueprint that will be deployed across the pipeline stages.</p>
<p>The framework allows defining a blueprint builder without instantiating the stack.</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">ssp</span> <span class="kr">from</span> <span class="s1">&#39;@aws-quickstart/ssp-amazon-eks&#39;</span>
<span class="k">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">team</span> <span class="kr">from</span> <span class="s1">&#39;path/to/teams&#39;</span>

<span class="kd">const</span> <span class="nx">blueprint</span> <span class="o">=</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">account</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span> <span class="c1">// the supplied default will fail, but build and synth will pass</span>
    <span class="p">.</span><span class="nx">region</span><span class="p">(</span><span class="s1">&#39;us-west-1&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addOns</span><span class="p">(</span>
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">AwsLoadBalancerControllerAddOn</span><span class="p">,</span> 
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">ExternalDnsAddOn</span><span class="p">,</span>
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">NginxAddOn</span><span class="p">,</span>
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">CalicoAddOn</span><span class="p">,</span>
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">MetricsServerAddOn</span><span class="p">,</span>
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">ClusterAutoScalerAddOn</span><span class="p">,</span>
        <span class="ow">new</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">ContainerInsightsAddOn</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">teams</span><span class="p">(</span><span class="ow">new</span> <span class="nx">team</span><span class="p">.</span><span class="nx">TeamRikerSetup</span><span class="p">);</span>
</code></pre></div>
<p>The difference between the above code and a normal way of instantiating the stack is lack of <code>.build()</code> at the end of the blueprint definition.
This code will produce a blueprint builder that can be instantiated inside the pipeline stages.</p>
<h2 id="creating-a-pipeline">Creating a pipeline<a class="headerlink" href="#creating-a-pipeline" title="Permanent link">&para;</a></h2>
<p>We can create a new <code>CodePipeline</code> resource via the following. </p>
<div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">ssp</span> <span class="kr">from</span> <span class="s1">&#39;@aws-quickstart/ssp-amazon-eks&#39;</span>

<span class="kd">const</span> <span class="nx">blueprint</span> <span class="o">=</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">...;</span> <span class="c1">// configure your blueprint builder</span>

 <span class="nx">ssp</span><span class="p">.</span><span class="nx">CodePipelineStack</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">&quot;ssp-eks-pipeline&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">owner</span><span class="p">(</span><span class="s2">&quot;aws-samples&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">repository</span><span class="p">({</span>
        <span class="nx">repoUrl</span><span class="o">:</span> <span class="s1">&#39;ssp-eks-patterns&#39;</span><span class="p">,</span>
        <span class="nx">credentialsSecretName</span><span class="o">:</span> <span class="s1">&#39;github-token&#39;</span><span class="p">,</span>
        <span class="nx">branch</span><span class="o">:</span> <span class="s1">&#39;main&#39;</span>
    <span class="p">})</span>
</code></pre></div>
<p>Note: the above code depends on the AWS secret <code>github-token</code> defined in the target account/region. The secret may be fined in one main region, and replicated to all target regions. </p>
<h2 id="creating-stages">Creating stages<a class="headerlink" href="#creating-stages" title="Permanent link">&para;</a></h2>
<p>Once our pipeline is created, we need to define <code>stages</code> for the pipeline. To do so, we can leverage <code>ssp.StackStage</code> convenience class and builder support for it. Let's continue leveraging the pipeline builder defined in the previous step.  </p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">blueprint</span> <span class="o">=</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">...;</span> <span class="c1">// configure your blueprint builder</span>

<span class="nx">ssp</span><span class="p">.</span><span class="nx">CodePipelineStack</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">&quot;ssp-eks-pipeline&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">owner</span><span class="p">(</span><span class="s2">&quot;aws-samples&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">repository</span><span class="p">({</span>
        <span class="c1">//  your repo info</span>
    <span class="p">})</span> 
    <span class="p">.</span><span class="nx">stage</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;us-west-1-managed-ssp-test&#39;</span><span class="p">,</span>
        <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-west-1&#39;</span><span class="p">)</span> <span class="c1">// clone the blueprint to customize for the stage. You can add more add-ons, teams here. </span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">stage</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;us-east-2-managed-ssp-prod&#39;</span><span class="p">,</span>
        <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-east-2&#39;</span><span class="p">),</span> <span class="c1">// clone the blueprint to customize for the stage. You can add more add-ons, team, here.</span>
        <span class="nx">stageProps</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">manualApprovals</span>: <span class="kt">true</span>
        <span class="p">}</span>
    <span class="p">})</span>
</code></pre></div>
<p>Consider adding <code>ArgoCDAddOn</code> with your specific workload bootstrap repository to automatically bootstrap workloads in the provisioned clusters.
See <a href="../addons/argo-cd/#Bootstrapping">Bootstrapping</a> for more details.</p>
<h2 id="adding-waves">Adding Waves<a class="headerlink" href="#adding-waves" title="Permanent link">&para;</a></h2>
<p>In many case, when enterprises configure their SDLC environments, such as dev/test/staging/prod, each environment may contain more than a single cluster. 
It is convenient to provision and maintain (update/upgrade) such clusters in parallel within the limits of the environment. Such environments may be represented as waves of the pipeline. The wave concept is not limited to just a logical environment. It may represent any grouping of clusters that should be executed in parallel. An important advantage of running stages in parallel is the time gain associated with it. Each stage may potentially take tens of minutes (e.g. initial provisioning, upgrade, etc.) and as the number of clusters increase, the overall pipeline run may become very lengthy and won't provide enough agility for the enterprise. Running parallel stages within a wave provides roughly the time performance equivalent to a single stage.</p>
<p>Pipeline functionality provides wave support to express waves with blueprints. You can mix individual stages and waves together. An individual stage can be viewed as a wave with a single stage. </p>
<div class="highlight"><pre><span></span><code><span class="nx">ssp</span><span class="p">.</span><span class="nx">CodePipelineStack</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">&quot;ssp-eks-pipeline&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">owner</span><span class="p">(</span><span class="s2">&quot;aws-samples&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">repository</span><span class="p">({</span>
        <span class="c1">//...</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">stage</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;us-west-1-managed-ssp&#39;</span><span class="p">,</span>
        <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-west-1&#39;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">wave</span><span class="p">(</span> <span class="p">{</span>  <span class="c1">// adding two clusters for dev env</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;dev&quot;</span><span class="p">,</span>
        <span class="nx">stages</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;dev-west-1&quot;</span><span class="p">,</span> <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-west-1&#39;</span><span class="p">).</span><span class="nx">account</span><span class="p">(</span><span class="nx">DEV_ACCOUNT</span><span class="p">)},</span> <span class="c1">// requires trust relationship with the code pipeline role</span>
            <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;dev-east-2&quot;</span><span class="p">,</span> <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-east-2&#39;</span><span class="p">).</span><span class="nx">account</span><span class="p">(</span><span class="nx">DEV_ACCOUNT</span><span class="p">)},</span> <span class="c1">// See https://docs.aws.amazon.com/cdk/api/v1/docs/pipelines-readme.html#cdk-environment-bootstrapping </span>

        <span class="p">]</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">wave</span><span class="p">(</span> <span class="p">{</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;prod&quot;</span><span class="p">,</span>
        <span class="nx">stages</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;prod-west-1&quot;</span><span class="p">,</span> <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-west-1&#39;</span><span class="p">)},</span>
            <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;prod-east-2&quot;</span><span class="p">,</span> <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-east-2&#39;</span><span class="p">)},</span>
        <span class="p">]</span>
    <span class="p">})</span>
</code></pre></div>
<h2 id="build-the-pipeline-stack">Build the pipeline stack<a class="headerlink" href="#build-the-pipeline-stack" title="Permanent link">&para;</a></h2>
<p>Now that we have defined the blueprint builder, the pipeline with repository and stages we just need to invoke the build() step to create the stack.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">blueprint</span> <span class="o">=</span> <span class="nx">ssp</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">...;</span> <span class="c1">// configure your blueprint builder</span>

<span class="nx">ssp</span><span class="p">.</span><span class="nx">CodePipelineStack</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="s2">&quot;ssp-eks-pipeline&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">owner</span><span class="p">(</span><span class="s2">&quot;aws-samples&quot;</span><span class="p">)</span> <span class="c1">// owner of your repo</span>
    <span class="p">.</span><span class="nx">repository</span><span class="p">({</span>
        <span class="c1">//  your repo info</span>
    <span class="p">})</span> 
    <span class="p">.</span><span class="nx">stage</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;dev&#39;</span><span class="p">,</span>
        <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-west-1&#39;</span><span class="p">)</span> <span class="c1">// clone the blueprint to customize for the stage. You can add more add-ons, teams here. </span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">stage</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span>
        <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-east-2&#39;</span><span class="p">),</span> <span class="c1">// clone the blueprint to customize for the stage. You can add more add-ons, team, here.</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">stage</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;prod&#39;</span><span class="p">,</span>
        <span class="nx">stackBuilder</span>: <span class="kt">blueprint.clone</span><span class="p">(</span><span class="s1">&#39;us-west-2&#39;</span><span class="p">),</span> <span class="c1">// clone the blueprint to customize for the stage. You can add more add-ons, team, here.</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s2">&quot;ssp-pipeline-stack&quot;</span><span class="p">,</span> <span class="nx">props</span><span class="p">);</span> <span class="c1">// will produce the self-mutating pipeline in the target region and start provisioning the defined blueprints.</span>
</code></pre></div>
<h2 id="deploying-pipelines">Deploying Pipelines<a class="headerlink" href="#deploying-pipelines" title="Permanent link">&para;</a></h2>
<p>In order to deploy pipelines, each environment (account and region) where pipeline will either be running and each environment to which it will be deploying should be bootstrapped based on CodePipeline <a href="https://docs.aws.amazon.com/cdk/api/v1/docs/pipelines-readme.html#cdk-environment-bootstrapping">documentation</a>.</p>
<p>Examples of bootstrapping (from the original documentation):</p>
<p>To bootstrap an environment for provisioning the pipeline:</p>
<p><div class="highlight"><pre><span></span><code>$ env <span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span> npx cdk bootstrap <span class="se">\</span>
    <span class="o">[</span>--profile admin-profile-1<span class="o">]</span> <span class="se">\</span>
    --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess <span class="se">\</span>
    aws://111111111111/us-east-1
</code></pre></div>
To bootstrap a different environment for deploying CDK applications into using a pipeline in account 111111111111:</p>
<div class="highlight"><pre><span></span><code>$ env <span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span> npx cdk bootstrap <span class="se">\</span>
    <span class="o">[</span>--profile admin-profile-2<span class="o">]</span> <span class="se">\</span>
    --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess <span class="se">\</span>
    --trust <span class="m">11111111111</span> <span class="se">\</span>
    aws://222222222222/us-east-2
</code></pre></div>
<p>If you only want to trust an account to do lookups (e.g, when your CDK application has a Vpc.fromLookup() call), use the option --trust-for-lookup:</p>
<div class="highlight"><pre><span></span><code>$ env <span class="nv">CDK_NEW_BOOTSTRAP</span><span class="o">=</span><span class="m">1</span> npx cdk bootstrap <span class="se">\</span>
    <span class="o">[</span>--profile admin-profile-2<span class="o">]</span> <span class="se">\</span>
    --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess <span class="se">\</span>
    --trust-for-lookup <span class="m">11111111111</span> <span class="se">\</span>
    aws://222222222222/us-east-2
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<p>SSP Build can fail with AccessDenied exception during build phase. Typical error messages:</p>
<div class="highlight"><pre><span></span><code>Error: AccessDeniedException: User: arn:aws:sts::&lt;account&gt;:assumed-role/ssp-pipeline-stack-sspekspipelinePipelineBuildSynt-1NPFJRH6H7TB1/AWSCodeBuild-e95830ee-07f6-46f5-aaee-90e269c7eb5f is not authorized to perform:
</code></pre></div>
<div class="highlight"><pre><span></span><code>current credentials could not be used to assume &#39;arn:aws:iam::&lt;account&gt;:role/cdk-hnb659fds-lookup-role-,account&gt;-eu-west-3&#39;, but are for the right account. Proceeding anyway.
</code></pre></div>
<div class="highlight"><pre><span></span><code>Error: you are not authorized to perform this operation. 
</code></pre></div>
<p>This can happen for a few reasons, but most typical is  related to the stack requiring elevated permissions at build time. Such permissions may be required to perform lookups, such as look up fo VPC, Hosted Zone, Certificate (if imported) and those are handled during stack synthesis. </p>
<p><strong>Resolution</strong></p>
<p>To address this issue, you can locate the role leveraged for Code Build and provide required permissions. Depending on the scope of the build role, the easiest resolution is to add <code>AdministratorAccess</code> permission to the build role which typically looks similar to this <code>ssp-pipeline-stack-sspekspipelinePipelineBuildSynt-1NPFJRH6H7TB1</code> provided your pipeline stack was named <code>ssp-pipeline-stack</code>. 
If adding administrative access to the role solves the issue, you can the consider tightening the role scope to just the required permissions, such as access to specific resources needed for the build.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../teams/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Teams" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Teams
            </div>
          </div>
        </a>
      
      
        
        <a href="../addons/" class="md-footer__link md-footer__link--next" aria-label="Next: Overview" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Overview
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.361d90f1.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
    
  </body>
</html>