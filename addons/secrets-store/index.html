
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>Secrets Store - Amazon EKS SSP Quick Start</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#secrets-store-add-on" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Amazon EKS SSP Quick Start" class="md-header__button md-logo" aria-label="Amazon EKS SSP Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS SSP Quick Start
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Secrets Store
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-quickstart/ssp-amazon-eks/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/ssp-amazon-eks
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Amazon EKS SSP Quick Start" class="md-nav__button md-logo" aria-label="Amazon EKS SSP Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Amazon EKS SSP Quick Start
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-quickstart/ssp-amazon-eks/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/ssp-amazon-eks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../core-concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../teams/" class="md-nav__link">
        Teams
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../pipelines/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          AddOns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AddOns" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          AddOns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../app-mesh/" class="md-nav__link">
        AWS App Mesh
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../argo-cd/" class="md-nav__link">
        ArgoCD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aws-load-balancer-controller/" class="md-nav__link">
        AWS Load Balancer Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../coredns/" class="md-nav__link">
        CoreDns
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-autoscaler/" class="md-nav__link">
        Cluster Autoscaler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../container-insights/" class="md-nav__link">
        Container Insights
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../external-dns/" class="md-nav__link">
        External DNS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kube-proxy/" class="md-nav__link">
        Kube Proxy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../metrics-server/" class="md-nav__link">
        Metrics Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nginx/" class="md-nav__link">
        Nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ssm-agent/" class="md-nav__link">
        SSM Agent
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Secrets Store
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Secrets Store
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#indexts" class="md-nav__link">
    index.ts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functionality" class="md-nav__link">
    Functionality
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    Security Considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../vpc-cni/" class="md-nav__link">
        Vpc Cni
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/weaveworks/weave-gitops-ssp-addon" class="md-nav__link">
        Weave GitOps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../xray/" class="md-nav__link">
        AWS XRay
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Cluster Providers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cluster Providers" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Cluster Providers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-providers/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-providers/asg-cluster-provider/" class="md-nav__link">
        ASG Cluster Provider
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-providers/mng-cluster-provider/" class="md-nav__link">
        MNG Cluster Provider
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-providers/fargate-cluster-provider/" class="md-nav__link">
        Fargate Cluster Provider
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../extensibility/" class="md-nav__link">
        Extensibility
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#indexts" class="md-nav__link">
    index.ts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#functionality" class="md-nav__link">
    Functionality
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    Security Considerations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/aws-quickstart/ssp-amazon-eks/edit/master/docs/addons/secrets-store.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="secrets-store-add-on">Secrets Store Add-on<a class="headerlink" href="#secrets-store-add-on" title="Permanent link">&para;</a></h1>
<p>The Secrets Store Add-on provisions the <a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html">AWS Secrets Manager and Config Provider(ASCP) for Secret Store CSI Driver</a> on your EKS cluster. With ASCP, you now have a plugin for the industry-standard Kubernetes Secrets Store <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver">Container Storage Interface (CSI) Driver</a> used for providing secrets to applications operating on Amazon Elastic Kubernetes Service.</p>
<p>With ASCP, you can securely store and manage your secrets in <a href="https://docs.aws.amazon.com/secretsmanager">AWS Secrets Manager</a> or <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html">AWS Systems Manager Parameter Store</a> and retrieve them through your application workloads running on Kubernetes. You no longer have to write custom code for your applications.</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<h3 id="indexts"><strong><code>index.ts</code></strong><a class="headerlink" href="#indexts" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">cdk</span> <span class="kr">from</span> <span class="s1">&#39;@aws-cdk/core&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span>
  <span class="nx">SecretProvider</span>
  <span class="nx">ClusterAddOn</span><span class="p">,</span>
  <span class="nx">EksBlueprint</span><span class="p">,</span>
  <span class="nx">ApplicationTeam</span>
<span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@aws-quickstart/ssp-amazon-eks&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ISecret</span><span class="p">,</span> <span class="nx">Secret</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">&#39;@aws-cdk/aws-secretsmanager&#39;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">addOn</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">SecretsStoreAddOn</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">addOns</span>: <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">ClusterAddOn</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">addOn</span> <span class="p">];</span>

<span class="cm">/* Setup application team with secrets</span>
<span class="cm"> * Here we are generating a new SecretManager secret for AuthPassword</span>
<span class="cm"> * We are also looking up a pre-existing secret in Parameter Store called GITHUB_TOKEN</span>
<span class="cm"> */</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">TeamBurnham</span> <span class="k">extends</span> <span class="nx">ApplicationTeam</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">scope</span>: <span class="kt">Construct</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">({</span>
            <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;burnham&quot;</span><span class="p">,</span>
            <span class="nx">users</span>: <span class="kt">getUserArns</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s2">&quot;team-burnham.users&quot;</span><span class="p">),</span>
            <span class="nx">teamSecrets</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nx">secretProvider</span>: <span class="kt">new</span> <span class="nx">GenerateSecretManagerProvider</span><span class="p">(</span><span class="s1">&#39;AuthPassword),</span>
<span class="s1">                    kubernetesSecret: {</span>
<span class="s1">                        secretName: &#39;</span><span class="nx">auth</span><span class="o">-</span><span class="nx">password</span><span class="s1">&#39;,</span>
<span class="s1">                        data: [</span>
<span class="s1">                            {</span>
<span class="s1">                                key: &#39;</span><span class="nx">password</span><span class="s1">&#39;</span>
<span class="s1">                            }</span>
<span class="s1">                        ]</span>
<span class="s1">                    }</span>
<span class="s1">                },</span>
<span class="s1">                {</span>
<span class="s1">                    secretProvider: new LookupSsmSecretByAttrs(&#39;</span><span class="nx">GITHUB_TOKEN</span><span class="s1">&#39;, 1),</span>
<span class="s1">                    kubernetesSecret: {</span>
<span class="s1">                        secretName: &#39;</span><span class="nx">github</span><span class="s1">&#39;</span>
<span class="s1">                    }</span>
<span class="s1">                }</span>
<span class="s1">            ]</span>
<span class="s1">        });</span>
<span class="s1">    }</span>
<span class="s1">}</span>

<span class="s1">class GenerateSecretManagerProvider implements SecretProvider {</span>

<span class="s1">    construct(private secretName: string) {}</span>

<span class="s1">    provide(clusterInfo: ClusterInfo): ISecret {</span>
<span class="s1">        const secret = new Secret(clusterInfo.cluster.stack, &#39;</span><span class="nx">AuthPassword</span><span class="s1">&#39;, {</span>
<span class="s1">          secretName: this.secretName</span>
<span class="s1">        });</span>

<span class="s1">        // create this secret first</span>
<span class="s1">        clusterInfo.cluster.node.addDependency(secret);</span>
<span class="s1">        return secret</span>
<span class="s1">    }</span>
<span class="s1">}</span>

<span class="s1">const app = new cdk.App();</span>
<span class="s1">const teams: Array&lt;ApplicationTeam&gt; = [ new TeamBurnham(app) ];</span>
<span class="s1">new EksBlueprint(app, &#39;</span><span class="nx">my</span><span class="o">-</span><span class="nx">stack</span><span class="o">-</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">addOns</span><span class="p">,</span> <span class="nx">teams</span><span class="p">});</span>
</code></pre></div>
<h2 id="functionality">Functionality<a class="headerlink" href="#functionality" title="Permanent link">&para;</a></h2>
<ol>
<li>Installs the <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver">Kubernetes Secrets Store CSI Driver</a> in the <code>kube-system</code> namespace.</li>
<li>Installs <a href="https://github.com/aws/secrets-store-csi-driver-provider-aws">AWS Secrets Manager and Config Provider for Secret Store CSI Driver</a> in the <code>kube-system</code> namespace.</li>
<li>Creates an IAM access policy for scoped down to just the secrets the provided namespace should have access to.</li>
<li>Updates <a href="https://docs.aws.amazon.com/eks/latest/userguide/create-service-account-iam-policy-and-role.html">IAM roles for service accounts</a> <code>[team-name]-sa</code> for policies to grant read access to the provided secrets.</li>
<li>Creates a <a href="https://github.com/aws/secrets-store-csi-driver-provider-aws#secretproviderclass-options">SecretProviderClass</a> <code>[team-name]-aws-secrets</code> which tells the AWS provider which secrets can be mounted in an application pod in the provided namespace.</li>
</ol>
<h2 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h2>
<p>The AWS Secrets Manger and Config Provider provides compatibility for legacy applications that access secrets as mounted files in the pod. Security conscious applications should use the native AWS APIs to fetch secrets and optionally cache them in memory rather than storing them in the file system.</p>
<h2 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h2>
<p>After the Blueprint stack is deployed you can test consuming the secret from within a <code>deployment</code>.</p>
<p>This sample <code>deployment</code> shows how to consume the secrets as mounted volumes as well as environment variables.</p>
<div class="highlight"><pre><span></span><code>cat <span class="s">&lt;&lt; EOF &gt;&gt; test-secrets.yaml</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: app-deployment</span>
<span class="s">  labels:</span>
<span class="s">    app: myapp</span>
<span class="s">  namespace: team-burnham</span>
<span class="s">spec:</span>
<span class="s">  replicas: 1</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      app: myapp</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      labels:</span>
<span class="s">        app: myapp</span>
<span class="s">    spec:</span>
<span class="s">      serviceAccountName: burnham-sa</span>
<span class="s">      volumes:</span>
<span class="s">      - name: secrets-store-inline</span>
<span class="s">        csi:</span>
<span class="s">          driver: secrets-store.csi.k8s.io</span>
<span class="s">          readOnly: true</span>
<span class="s">          volumeAttributes:</span>
<span class="s">            secretProviderClass: burnham-aws-secrets</span>
<span class="s">      containers:</span>
<span class="s">      - name: test-secrets</span>
<span class="s">        image: public.ecr.aws/ubuntu/ubuntu:latest</span>
<span class="s">        command: [ &quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot; ]</span>
<span class="s">        args: [ &quot;while true; do sleep 30; done;&quot; ]</span>
<span class="s">        resources:</span>
<span class="s">          limits:</span>
<span class="s">            cpu: &quot;100m&quot;</span>
<span class="s">            memory: &quot;128Mi&quot;</span>
<span class="s">          requests:</span>
<span class="s">            cpu: &quot;100m&quot;</span>
<span class="s">            memory: &quot;128Mi&quot;</span>
<span class="s">        env:</span>
<span class="s">          - name: PASSWORD</span>
<span class="s">            valueFrom:</span>
<span class="s">              secretKeyRef:</span>
<span class="s">                name: auth-password</span>
<span class="s">                key: password</span>
<span class="s">          - name: GITHUB_TOKEN</span>
<span class="s">            valueFrom:</span>
<span class="s">              secretKeyRef:</span>
<span class="s">                name: github</span>
<span class="s">                key: GITHUB_TOKEN</span>
<span class="s">        volumeMounts:</span>
<span class="s">          - name: secrets-store-inline</span>
<span class="s">            mountPath: /mnt/secrets-store</span>
<span class="s">            readOnly: true</span>
<span class="s">EOF</span>
</code></pre></div>
<p>The values for <code>serviceAccountName</code> and the <code>secretProviderClass</code> shown in the example above are obtained from CloudFormation outputs of the blueprint stack shown in the screenshot below as <code>burnhamsa</code> and <code>teamburnhamsecretproviderclass</code>.</p>
<p><img alt="outputs" src="../../assets/images/cloudformation-outputs.png" /></p>
<p>Apply the manifest.</p>
<div class="highlight"><pre><span></span><code>$ kubectl apply -f test-secrets.yaml
deployment.apps/app-deployment created
</code></pre></div>
<p>Test that kubernetes secret <code>burnham-github-secrets</code> was created.</p>
<div class="highlight"><pre><span></span><code>kubectl get secrets -n team-burnham
NAME                     TYPE                                  DATA   AGE
auth-password            Opaque                                <span class="m">1</span>      19s
burnham-sa-token-fqjqw   kubernetes.io/service-account-token   <span class="m">3</span>      64m
default-token-7fn69      kubernetes.io/service-account-token   <span class="m">3</span>      64m
github                   Opaque                                <span class="m">1</span>      19s
</code></pre></div>
<p>Test that the deployment has completed and the pod is running successfully.</p>
<div class="highlight"><pre><span></span><code>$ kubectl get pods -n team-burnham
NAME                              READY   STATUS    RESTARTS   AGE
app-deployment-6867fc6bd6-jzdwh   <span class="m">1</span>/1     Running   <span class="m">0</span>          46s
</code></pre></div>
<p>Next, test whether the secret <code>PASSWORD</code> is available as an environment variable from within the <code>app-deployment</code> pod.</p>
<div class="highlight"><pre><span></span><code>$ kubectl <span class="nb">exec</span> app-deployment-6867fc6bd6-jzdwh -n team-burnham -- <span class="nb">echo</span> <span class="nv">$PASSWORD</span>

XXXXXXXXXXXXXXXXXX
</code></pre></div>
<p>Test whether <code>GITHUB_TOKEN</code> is available as an environment variable from within the <code>app-deployment</code> pod.</p>
<div class="highlight"><pre><span></span><code>$ kubectl <span class="nb">exec</span> app-deployment-6867fc6bd6-jzdwh -n team-burnham -- <span class="nb">echo</span> <span class="nv">$GITHUB_TOKEN</span>

ghp_XXXXXXXXXXXXXXXXXXXXXXXXXX
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../ssm-agent/" class="md-footer__link md-footer__link--prev" aria-label="Previous: SSM Agent" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              SSM Agent
            </div>
          </div>
        </a>
      
      
        
        <a href="../vpc-cni/" class="md-footer__link md-footer__link--next" aria-label="Next: Vpc Cni" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Vpc Cni
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.361d90f1.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
    
  </body>
</html>