
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.5">
    
    
      
        <title>What is OPA Gatekeeper? - Amazon EKS Blueprints Quick Start</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#what-is-opa-gatekeeper" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Amazon EKS Blueprints Quick Start" class="md-header__button md-logo" aria-label="Amazon EKS Blueprints Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS Blueprints Quick Start
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              What is OPA Gatekeeper?
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aws-quickstart/cdk-eks-blueprints/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/cdk-eks-blueprints
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Amazon EKS Blueprints Quick Start" class="md-nav__button md-logo" aria-label="Amazon EKS Blueprints Quick Start" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Amazon EKS Blueprints Quick Start
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-quickstart/cdk-eks-blueprints/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-quickstart/cdk-eks-blueprints
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../core-concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../teams/" class="md-nav__link">
        Teams
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pipelines/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        AddOns
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="AddOns" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          AddOns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/app-mesh/" class="md-nav__link">
        AWS App Mesh
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/argo-cd/" class="md-nav__link">
        ArgoCD
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/aws-for-fluent-bit/" class="md-nav__link">
        AWS For Fluent Bit
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/aws-load-balancer-controller/" class="md-nav__link">
        AWS Load Balancer Controller
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/aws-node-termination-handler/" class="md-nav__link">
        AWS Node Termination Handler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/cluster-autoscaler/" class="md-nav__link">
        Cluster Autoscaler
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/container-insights/" class="md-nav__link">
        Container Insights
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/coredns/" class="md-nav__link">
        CoreDns
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/dynatrace-oss/dynatrace-eks-blueprints-addon" class="md-nav__link">
        Dynatrace
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/ebs-csi-driver/" class="md-nav__link">
        EBS CSI Driver
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/efs-csi-driver/" class="md-nav__link">
        EFS CSI Driver
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/external-dns/" class="md-nav__link">
        External DNS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/karpenter/" class="md-nav__link">
        Karpenter
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/keptn-sandbox/keptn-eks-blueprints-addon" class="md-nav__link">
        Keptn
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/kube-proxy/" class="md-nav__link">
        Kube Proxy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/kubecost/" class="md-nav__link">
        Kubecost
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/kubevious/" class="md-nav__link">
        Kubevious
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/metrics-server/" class="md-nav__link">
        Metrics Server
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/newrelic/" class="md-nav__link">
        New Relic
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/nginx/" class="md-nav__link">
        Nginx
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/opa-gatekeeper/" class="md-nav__link">
        OPA Gatekeeper
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/secrets-store/" class="md-nav__link">
        Secrets Store
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/ssm-agent/" class="md-nav__link">
        SSM Agent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/velero/" class="md-nav__link">
        Velero
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/vpc-cni/" class="md-nav__link">
        Vpc Cni
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/weaveworks/weave-gitops-ssp-addon" class="md-nav__link">
        Weave GitOps
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../addons/xray/" class="md-nav__link">
        AWS XRay
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Cluster Providers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Cluster Providers" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Cluster Providers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/generic-cluster-provider/" class="md-nav__link">
        Generic Cluster Provider
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/asg-cluster-provider/" class="md-nav__link">
        ASG Cluster Provider
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/mng-cluster-provider/" class="md-nav__link">
        MNG Cluster Provider
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cluster-providers/fargate-cluster-provider/" class="md-nav__link">
        Fargate Cluster Provider
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../extensibility/" class="md-nav__link">
        Extensibility
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-terminology" class="md-nav__link">
    Key Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-with-opa-gatekeeper" class="md-nav__link">
    Example with OPA Gatekeeper
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-quickstart/cdk-eks-blueprints/edit/master/docs/opa-gatekeeper.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="what-is-opa-gatekeeper">What is OPA Gatekeeper?<a class="headerlink" href="#what-is-opa-gatekeeper" title="Permanent link">&para;</a></h1>
<p>The Open Policy Agent (OPA, pronounced “oh-pa”) is an open source, general-purpose policy engine that unifies policy enforcement across the stack. OPA provides a high-level declarative language that lets you specify policy as code and simple APIs to offload policy decision-making from your software. You can use OPA to enforce policies in microservices, Kubernetes, CI/CD pipelines, API gateways, and more. OPA uses a policy language known as Rego which is a query language which was purpose built to support structured document models such as JSON. To learn more about Rego check out this <a href="https://www.openpolicyagent.org/docs/latest/policy-language/">link</a>.</p>
<p>OPA Gatekeeper is an open-source project that provides a first-class integration between OPA and Kubernetes. What Gatekeeper adds is an extensible parameterized policy library that includes native Kubernetes CRD's for instantiating and extending the OPA policy library. The Kubernetes API Server is configured to query OPA for admission control decisions when objects (e.g., Pods, Services, etc.) are created, updated, or deleted. The API Server sends the entire Kubernetes object in the webhook request to OPA. OPA evaluates the policies it has loaded using the admission review as input. Gatekeeper also provides audit functionality as well. The diagram below shows the flow between a user making a request to the Kube-API server and how AdmissionReview and AdmissionRequests are made through OPA Gatekeeper. </p>
<p><img alt="opa" src="https://d33wubrfki0l68.cloudfront.net/a5ed0c27ff2dda6abb18b9bc960f2ad4120d937a/a5939/docs/latest/images/kubernetes-admission-flow.png" />)</p>
<p>In the context of a development platform running on Amazon EKS, platform teams and administrators need a way of being able to set policies to adhere to governance and security requirements for all workloads and teams working on the same cluster. Examples of standard use cases for using policies via OPA Gatekeeper are listed below:</p>
<ul>
<li>Which users can access which resources.</li>
<li>Which subnets egress traffic is allowed to.</li>
<li>Which clusters a workload must be deployed to.</li>
<li>Which registries binaries can be downloaded from.</li>
<li>Which OS capabilities a container can execute with.</li>
<li>Which times of day the system can be accessed at.</li>
</ul>
<p>RBAC (role-based access control) can help with some of the scenarios above but <strong>roles are nothing but a group of permissions that you then assign to users leveraging rolebindings.</strong> If for example, a user tries to perform an operation (get, list, watch, create, etc...) that particular user may do so if they have the appropriate role. <strong>Please note that RBAC should be used in conjunction with OPA Gatekeeper policies to fully secure your cluster.</strong></p>
<h2 id="key-terminology">Key Terminology<a class="headerlink" href="#key-terminology" title="Permanent link">&para;</a></h2>
<ul>
<li>OPA Constraint Framework - Framework that enforces CRD-based policies and allow declaratively configured policies to be reliably shareable</li>
<li>Constraint -  A Constraint is a declaration that its author wants a system to meet a given set of requirements. Each Constraint is written with Rego, a declarative query language used by OPA to enumerate instances of data that violate the expected state of the system. All Constraints are evaluated as a logical AND. If one Constraint is not satisfied, then the whole request is rejected.</li>
<li>Enforcement Point - Places where constraints can be enforced. Examples are Git hooks, Kubernetes admission controllers, and audit systems.</li>
<li>Constraint Template - Templates that allows users to declare new constraints </li>
<li>Target - Represents a coherent set of objects sharing a common identification and/or selection scheme, generic purpose, and can be analyzed in the same validation context</li>
</ul>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="k">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">blueprints</span> <span class="k">from</span> <span class="s1">&#39;@aws-quickstart/eks-blueprints&#39;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cdk</span><span class="p">.</span><span class="nx">App</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">AWS_ACCOUNT_ID</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">region</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">AWS_REGION</span><span class="o">&gt;</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">blueprint</span> <span class="o">=</span> <span class="nx">blueprints</span><span class="p">.</span><span class="nx">EksBlueprint</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">account</span><span class="p">(</span><span class="nx">account</span><span class="p">)</span> 
  <span class="p">.</span><span class="nx">region</span><span class="p">(</span><span class="nx">region</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">addOns</span><span class="p">(</span> <span class="k">new</span> <span class="nx">blueprints</span><span class="p">.</span><span class="nx">addons</span><span class="p">.</span><span class="nx">OpaGatekeeperAddOn</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">.</span><span class="nx">teams</span><span class="p">().</span><span class="nx">build</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="s1">&#39;my-stack-name&#39;</span><span class="p">);</span>
</code></pre></div>
<p>To validate that OPA Gatekeeper is running within your cluster run the following command:</p>
<div class="highlight"><pre><span></span><code>k get po -n gatekeeper-system
</code></pre></div>
<p>You should see the following output:</p>
<p><div class="highlight"><pre><span></span><code>NAME                                             READY   STATUS    RESTARTS   AGE
gatekeeper-audit-7c5998d4c-b5n7j                 <span class="m">1</span>/1     Running   <span class="m">0</span>          1d
gatekeeper-controller-manager-5894545cc9-b86zm   <span class="m">1</span>/1     Running   <span class="m">0</span>          1d
gatekeeper-controller-manager-5894545cc9-bntdt   <span class="m">1</span>/1     Running   <span class="m">0</span>          1d
gatekeeper-controller-manager-5894545cc9-tb7fz   <span class="m">1</span>/1     Running   <span class="m">0</span>          1d
</code></pre></div>
You will notice the <code>gatekeeper-audit-7c5998d4c-b5n7j</code> pod that is created when we deploy the <code>OpaGatekeeperAddOn</code>. The audit functionality enables periodic evaluations of replicated resources against the Constraints enforced in the cluster to detect pre-existing misconfigurations. Gatekeeper stores audit results as violations listed in the status field of the relevant Constraint. The <code>gatekeeper-controller-manager</code> is simply there to manage the <code>OpaGatekeeperAddOn</code>. </p>
<h2 id="example-with-opa-gatekeeper">Example with OPA Gatekeeper<a class="headerlink" href="#example-with-opa-gatekeeper" title="Permanent link">&para;</a></h2>
<p>For the purposes of operating within a platform defined by <code>EKS Blueprints</code>, we will be focusing on how to use a policy driven approach to secure our cluster using OPA Gatekeeper. The OPA Gatekeeper community has created a library of example policies and constraint templates which can be found <a href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general">here</a>. In this example we will create a policy that enforces including labels for newly created namespaces and pods. The ConstraintTemplate can be found <a href="https://github.com/open-policy-agent/gatekeeper-library/blob/master/library/general/requiredlabels/template.yaml">here</a>.</p>
<p>Run the following command to create the ConstraintTemplate:</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/requiredlabels/template.yaml
</code></pre></div>
<p>To verify that the ConstraintTemplate was created run the following command:</p>
<div class="highlight"><pre><span></span><code>kubectl get constrainttemplate
</code></pre></div>
<p>You should see the following output:</p>
<div class="highlight"><pre><span></span><code>NAME                AGE
k8srequiredlabels   45s
</code></pre></div>
<p>You will notice that if you create a new namespace without any labels that the request will go through and that is because we now need to create the individual <code>Constraint CRD</code> as defined by the <code>Constraint Template</code> that we created above. Let's create the individal <code>Constraint CRD</code> using the command below: </p>
<div class="highlight"><pre><span></span><code>k apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/requiredlabels/samples/all-must-have-owner/constraint.yaml           
</code></pre></div>
<p>If we then try and create a namespace by running <code>kubectl create ns test</code> (notice that we are not adding any labels) you will get the following error message:</p>
<div class="highlight"><pre><span></span><code>Error from server <span class="o">([</span>all-must-have-owner<span class="o">]</span> All namespaces must have an <span class="sb">`</span>owner<span class="sb">`</span> label that points to your company username<span class="o">)</span>: admission webhook <span class="s2">&quot;validation.gatekeeper.sh&quot;</span> denied the request: <span class="o">[</span>all-must-have-owner<span class="o">]</span> All namespaces must have an <span class="sb">`</span>owner<span class="sb">`</span> label that points to your company username
</code></pre></div>
<p>For more information on OPA Gatekeeper please refer to the links below:</p>
<ul>
<li>https://github.com/open-policy-agent</li>
<li>https://open-policy-agent.github.io/gatekeeper/website/docs/</li>
<li>https://github.com/open-policy-agent/gatekeeper-library </li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.d351de03.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.a1609d9a.min.js"></script>
      
    
  </body>
</html>